<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Revenue CSV Transformer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .input-section {
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .input-group input[type="text"] {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .csv-input {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }
        
        .csv-input:focus {
            outline: none;
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            display: inline-block;
            margin: 10px 10px 10px 0;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #48bb78;
        }
        
        .btn-danger {
            background: #e53e3e;
        }
        
        .output-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #718096;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .preview-container {
            margin-top: 20px;
            max-height: 400px;
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .preview-table th {
            background: #f7fafc;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
        }
        
        .preview-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .instructions {
            background: #fef5e7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f39c12;
        }
        
        .instructions h3 {
            color: #d68910;
            margin-bottom: 10px;
        }
        
        .instructions ul {
            margin-left: 20px;
            color: #9c640c;
        }
        
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Project Revenue CSV Transformer</h1>
            <p>Transform wide-format project data into monthly upload format</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>üìã How to use</h3>
                <ul>
                    <li>Enter the Cost Center (this would normally be your filename without .csv)</li>
                    <li>Paste your CSV data with project rows and monthly columns</li>
                    <li>The tool will extract the 18-digit ID from URLs in column B</li>
                    <li>Each month's revenue will become a separate row</li>
                    <li>Update keys will be generated automatically</li>
                    <li>Output filename format: CostCenter_upload_ready_YYYY-MM-DD.csv</li>
                </ul>
            </div>
            
            <div class="input-section">
                <div class="input-group">
                    <label for="costCenter">Cost Center (e.g., CC100902):</label>
                    <input type="text" id="costCenter" placeholder="Enter cost center code">
                </div>
                
                <div class="input-group">
                    <label for="csvInput">Paste your CSV data here:</label>
                    <textarea id="csvInput" class="csv-input" placeholder="Paste your CSV content here...
Example:
Date - Year,,,,,,2025,2025,2025...
MonthShortName,,,,,,Jan,Feb,Mar...
ID,SF,Pursuit / Project Name,Liaison,practice,Stage,100,200,300..."></textarea>
                </div>
                
                <button class="btn" onclick="transformData()">
                    üîÑ Transform Data
                </button>
                <button class="btn btn-danger" onclick="clearAll()">
                    üóëÔ∏è Clear All
                </button>
            </div>
            
            <div id="outputSection" class="output-section" style="display: none;">
                <h3>‚úÖ Transformed Data</h3>
                <div id="stats" class="stats"></div>
                <div class="input-group">
                    <label>Copy this CSV data or download as file:</label>
                    <textarea id="csvOutput" class="csv-input" readonly></textarea>
                </div>
                <button class="btn btn-secondary" onclick="downloadCSV()">
                    ‚¨áÔ∏è Download as CSV file
                </button>
                <button class="btn" onclick="copyToClipboard()">
                    üìã Copy to Clipboard
                </button>
                
                <h4 style="margin-top: 30px;">Preview (first 10 rows):</h4>
                <div id="preview" class="preview-container"></div>
            </div>
            
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let transformedData = [];

        function extractSFID(url) {
            // Extract 18-character ID from URL
            if (!url) return '';
            const match = url.match(/[a-zA-Z0-9]{18}/);
            return match ? match[0] : '';
        }

        function getMonthName(monthAbbr) {
            const monthMap = {
                'jan': 'January', 'feb': 'February', 'mar': 'March', 'apr': 'April',
                'may': 'May', 'jun': 'June', 'jul': 'July', 'aug': 'August',
                'sep': 'September', 'oct': 'October', 'nov': 'November', 'dec': 'December'
            };
            const lower = monthAbbr.toLowerCase();
            return monthMap[lower] || monthAbbr;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const rows = [];
            
            for (let line of lines) {
                // Handle quoted values properly
                const row = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                row.push(current.trim());
                rows.push(row);
            }
            
            return rows;
        }

        function transformData() {
            const costCenter = document.getElementById('costCenter').value.trim();
            const csvInput = document.getElementById('csvInput').value.trim();
            
            if (!costCenter) {
                showMessage('Please enter a Cost Center', 'error');
                return;
            }
            
            if (!csvInput) {
                showMessage('Please paste CSV data', 'error');
                return;
            }
            
            try {
                const rows = parseCSV(csvInput);
                
                // Find the year row and month row
                let yearRow = null;
                let monthRow = null;
                let dataStartRow = null;
                
                for (let i = 0; i < Math.min(5, rows.length); i++) {
                    const row = rows[i];
                    // Check for year row (contains multiple year values like 2025, 2026)
                    if (row.some(cell => cell === '2025' || cell === '2026' || cell === '2024')) {
                        yearRow = row;
                    }
                    // Check for month row
                    if (row.some(cell => ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                         'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].includes(cell))) {
                        monthRow = row;
                        dataStartRow = i + 1;
                        break;
                    }
                }
                
                if (!yearRow || !monthRow || !dataStartRow) {
                    showMessage('Could not find year/month headers in the CSV data', 'error');
                    return;
                }
                
                transformedData = [];
                const headers = ['SFID', 'CostCenter', 'Month', 'Year', 'Fee_Estimate__c', 'UpdateKey__c', 'practice group'];
                
                // Process each data row
                for (let i = dataStartRow; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length < 6) continue;
                    
                    // Extract data from fixed columns
                    const urlColumn = row[1] || ''; // Column B - URL with SFID
                    const practiceGroup = row[4] || ''; // Column E - practice group
                    
                    // Skip if no URL
                    if (!urlColumn) continue;
                    
                    const sfid = extractSFID(urlColumn);
                    if (!sfid) continue;
                    
                    // Process each month column (starting from column 6/index 5)
                    for (let j = 6; j < row.length; j++) {
                        const revenue = row[j];
                        if (!revenue || revenue === '0' || revenue === '') continue;
                        
                        const month = monthRow[j];
                        const year = yearRow[j];
                        
                        if (!month || !year) continue;
                        
                        const monthName = getMonthName(month);
                        const updateKey = `${sfid}${costCenter}${monthName}${year}${practiceGroup}`;
                        
                        transformedData.push({
                            SFID: sfid,
                            CostCenter: costCenter,
                            Month: monthName,
                            Year: year,
                            Fee_Estimate__c: revenue,
                            UpdateKey__c: updateKey,
                            'practice group': practiceGroup
                        });
                    }
                }
                
                if (transformedData.length === 0) {
                    showMessage('No data to transform. Check that your CSV has valid data.', 'error');
                    return;
                }
                
                displayOutput();
                showMessage(`Successfully transformed ${transformedData.length} rows!`, 'success');
                
            } catch (error) {
                showMessage('Error transforming data: ' + error.message, 'error');
                console.error(error);
            }
        }

        function displayOutput() {
            // Show output section
            document.getElementById('outputSection').style.display = 'block';
            
            // Generate CSV output
            const csvLines = [];
            const headers = ['SFID', 'CostCenter', 'Month', 'Year', 'Fee_Estimate__c', 'UpdateKey__c', 'practice group'];
            csvLines.push(headers.join(','));
            
            for (let row of transformedData) {
                const line = headers.map(h => row[h] || '').join(',');
                csvLines.push(line);
            }
            
            const csvOutput = csvLines.join('\n');
            document.getElementById('csvOutput').value = csvOutput;
            
            // Display stats
            const uniqueProjects = new Set(transformedData.map(r => r.SFID)).size;
            const totalRows = transformedData.length;
            const uniqueMonths = new Set(transformedData.map(r => `${r.Month} ${r.Year}`)).size;
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalRows}</div>
                    <div class="stat-label">Total Rows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueProjects}</div>
                    <div class="stat-label">Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${uniqueMonths}</div>
                    <div class="stat-label">Months</div>
                </div>
            `;
            
            // Display preview table
            let tableHTML = '<table class="preview-table"><thead><tr>';
            for (let header of headers) {
                tableHTML += `<th>${header}</th>`;
            }
            tableHTML += '</tr></thead><tbody>';
            
            for (let i = 0; i < Math.min(10, transformedData.length); i++) {
                tableHTML += '<tr>';
                for (let header of headers) {
                    tableHTML += `<td>${transformedData[i][header] || ''}</td>`;
                }
                tableHTML += '</tr>';
            }
            
            tableHTML += '</tbody></table>';
            document.getElementById('preview').innerHTML = tableHTML;
        }

        function downloadCSV() {
            const csvContent = document.getElementById('csvOutput').value;
            const costCenter = document.getElementById('costCenter').value.trim();
            
            // Get current date in YYYY-MM-DD format
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            // Create filename: CostCenter_upload_ready_YYYY-MM-DD.csv
            const filename = `${costCenter}_upload_ready_${dateStr}.csv`;
            
            // Create blob with BOM for Excel compatibility
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // Create download link
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            showMessage(`File downloaded: ${filename}`, 'success');
        }

        function copyToClipboard() {
            const csvOutput = document.getElementById('csvOutput');
            csvOutput.select();
            csvOutput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                showMessage('Copied to clipboard!', 'success');
            } catch (err) {
                showMessage('Failed to copy. Please select and copy manually.', 'error');
            }
        }

        function clearAll() {
            document.getElementById('costCenter').value = '';
            document.getElementById('csvInput').value = '';
            document.getElementById('csvOutput').value = '';
            document.getElementById('outputSection').style.display = 'none';
            document.getElementById('messages').innerHTML = '';
            transformedData = [];
        }

        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${message}</div>`;
            
            // Auto-clear success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messagesDiv.innerHTML = '';
                }, 3000);
            }
        }
    </script>
</body>
</html>
